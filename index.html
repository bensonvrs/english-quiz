<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GEPT Comic Adventure | æ¼«ç•«è‹±èªå†’éšª</title>
    
    <!-- æ ¸å¿ƒåº« (ç›´æ¥å¼•å…¥ï¼Œç„¡éœ€å®‰è£) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts: æ¼«ç•«èˆ‡åœ“é«”å­—å‹ -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <!-- Markdown è§£æ (ç”¨æ–¼é¡¯ç¤º AI å›æ‡‰) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Tailwind è‡ªå®šç¾©é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        comic: ['Bangers', 'cursive'],
                        sans: ['Fredoka', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        'comic-yellow': '#FFD93D',
                        'comic-red': '#FF6B6B',
                        'comic-blue': '#4D96FF',
                        'comic-green': '#6BCB77',
                        'comic-black': '#1A1A1A',
                        'comic-purple': '#A66CFF',
                    },
                    boxShadow: {
                        'comic': '4px 4px 0px 0px #1A1A1A',
                        'comic-hover': '2px 2px 0px 0px #1A1A1A',
                        'comic-lg': '8px 8px 0px 0px #1A1A1A',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #6BCB77;
            background-image: radial-gradient(#4D96FF 20%, transparent 20%),
                              radial-gradient(#FAFAFA 20%, transparent 20%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            overflow: hidden;
        }

        /* æ¼«ç•«ç¶²é»èƒŒæ™¯ç‰¹æ•ˆ */
        .halftone-bg {
            background-image: radial-gradient(circle, #1A1A1A 2px, transparent 2.5px);
            background-size: 15px 15px;
            opacity: 0.1;
        }

        /* æ¼«ç•«éœ‡å‹•ç‰¹æ•ˆ */
        @keyframes pow {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            70% { transform: scale(0.9) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .animate-pow { animation: pow 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* èªéŸ³æ³¢ç´‹å‹•ç•« */
        @keyframes wave {
            0% { height: 5px; }
            50% { height: 20px; }
            100% { height: 5px; }
        }
        .voice-wave span {
            display: inline-block;
            width: 4px;
            background: #FF6B6B;
            border-radius: 4px;
            animation: wave 1s infinite ease-in-out;
            margin: 0 2px;
        }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        /* Loading Spinner */
        .comic-loader {
            width: 48px;
            height: 48px;
            border: 5px solid #1A1A1A;
            border-bottom-color: #FFD93D;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="app" class="relative w-full h-screen max-w-lg mx-auto flex flex-col overflow-hidden bg-white border-x-4 border-comic-black shadow-2xl">
        
        <!-- é ‚éƒ¨æ¼«ç•«æ¨™é¡Œ -->
        <header class="bg-comic-yellow border-b-4 border-comic-black p-4 flex justify-between items-center z-20 relative">
            <div class="flex items-center gap-2">
                <button v-if="currentScreen !== 'home'" @click="goHome" class="bg-white border-2 border-comic-black rounded-full w-10 h-10 flex items-center justify-center shadow-comic-hover hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none transition-all">
                    <i class="fa-solid fa-house text-comic-black"></i>
                </button>
                <h1 class="font-comic text-2xl tracking-wider text-comic-black drop-shadow-sm">
                    <span class="text-comic-red">GEPT</span> HERO
                </h1>
            </div>
            
            <!-- ç­‰ç´šèˆ‡åˆ†æ•¸ -->
            <div class="flex gap-2">
                <div v-if="difficulty" class="bg-comic-black text-white px-3 py-1 rounded-lg text-xs font-bold border-2 border-comic-black transform -rotate-2">
                    {{ difficulty === 'easy' ? 'åˆç´š LV.1' : 'ä¸­ç´š LV.5' }}
                </div>
                <div class="bg-white border-2 border-comic-black px-3 py-1 rounded-lg text-sm font-bold shadow-comic-hover flex items-center gap-1">
                    <i class="fa-solid fa-star text-comic-yellow"></i> {{ score }}
                </div>
            </div>
        </header>

        <!-- ä¸»å…§å®¹å€ -->
        <main class="flex-1 relative overflow-hidden flex flex-col">
            
            <!-- AI Loading Overlay -->
            <transition name="fade">
                <div v-if="isAiLoading" class="absolute inset-0 z-[60] bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center p-6 text-center">
                    <span class="comic-loader mb-4"></span>
                    <h3 class="font-comic text-3xl text-comic-blue animate-bounce">Generating...</h3>
                    <p class="font-bold text-comic-black">AI æ­£åœ¨å‰µé€  "{{ userTheme || 'éš¨æ©Ÿå†’éšª' }}" é—œå¡...</p>
                    <p class="text-sm text-gray-500 mt-2">Connecting to Gemini API</p>
                </div>
            </transition>

            <!-- 1. é›£åº¦é¸æ“‡é¦–é  (Home) -->
            <transition name="fade">
                <div v-if="currentScreen === 'home'" class="absolute inset-0 flex flex-col p-6 items-center justify-center z-10 bg-[#FFFBEB]">
                    <div class="halftone-bg absolute inset-0 pointer-events-none"></div>
                    
                    <!-- è¨­å®šæŒ‰éˆ• (Settings Button) -->
                    <button @click="showSettings = true" class="absolute top-4 right-4 bg-white border-2 border-comic-black w-10 h-10 rounded-full flex items-center justify-center shadow-comic-hover hover:scale-110 transition-transform z-20" title="è¨­å®š API Key">
                        <i class="fa-solid fa-gear text-comic-black"></i>
                    </button>

                    <div class="relative mb-8 transform hover:scale-105 transition-transform duration-300 cursor-pointer animate-pow">
                        <div class="bg-comic-red text-white font-comic text-6xl px-6 py-4 border-4 border-comic-black shadow-comic-lg rotate-3 z-10 relative">
                            START!
                        </div>
                        <div class="absolute -top-6 -right-6 text-comic-blue text-4xl animate-bounce">âš¡ï¸</div>
                    </div>

                    <h2 class="text-xl font-bold mb-6 text-comic-black text-center">é¸æ“‡ä½ çš„æŒ‘æˆ°ç­‰ç´š</h2>

                    <div class="w-full space-y-4 relative z-10">
                        <!-- åˆç´šæŒ‰éˆ• -->
                        <button @click="selectDifficulty('easy')" class="w-full bg-comic-green border-4 border-comic-black p-4 rounded-xl shadow-comic active:shadow-none active:translate-x-[4px] active:translate-y-[4px] transition-all group">
                            <div class="flex items-center justify-between">
                                <div class="text-left">
                                    <div class="font-comic text-2xl text-white text-stroke">ROOKIE</div>
                                    <div class="text-comic-black font-bold">åˆç´šå­¸å¾’ (Elementary)</div>
                                </div>
                                <i class="fa-solid fa-seedling text-4xl text-white group-hover:scale-110 transition-transform"></i>
                            </div>
                        </button>

                        <!-- ä¸­ç´šæŒ‰éˆ• -->
                        <button @click="selectDifficulty('hard')" class="w-full bg-comic-blue border-4 border-comic-black p-4 rounded-xl shadow-comic active:shadow-none active:translate-x-[4px] active:translate-y-[4px] transition-all group">
                            <div class="flex items-center justify-between">
                                <div class="text-left">
                                    <div class="font-comic text-2xl text-white text-stroke">HERO</div>
                                    <div class="text-comic-black font-bold">ä¸­ç´šè‹±é›„ (Intermediate)</div>
                                </div>
                                <i class="fa-solid fa-shield-cat text-4xl text-white group-hover:scale-110 transition-transform"></i>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-8 bg-white border-2 border-comic-black p-3 rounded-lg text-xs font-bold text-center shadow-comic-hover rotate-1">
                        âœ¨ åŒ…å« Gemini AI é©…å‹•çš„è‡ªè¨‚ä¸»é¡Œé—œå¡
                    </div>
                </div>
            </transition>

            <!-- 2. æŠ€èƒ½é¸æ“‡åœ°åœ– (Skill Map) -->
            <transition name="fade">
                <div v-if="currentScreen === 'skill-map'" class="absolute inset-0 flex flex-col p-6 bg-white overflow-y-auto">
                    <h2 class="text-center font-bold text-2xl mb-6 border-b-4 border-comic-yellow inline-block mx-auto px-4">
                        {{ difficulty === 'easy' ? 'åˆç´šè©¦ç…‰' : 'ä¸­ç´šæŒ‘æˆ°' }}
                    </h2>

                    <!-- AI è‡ªè¨‚ä¸»é¡Œè¼¸å…¥ (New Feature) -->
                    <div class="bg-comic-purple/10 border-4 border-comic-purple border-dashed rounded-2xl p-4 mb-6">
                        <label class="block text-comic-purple font-bold mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> 
                            è¼¸å…¥å–œæ­¡çš„ä¸»é¡Œ (å¦‚: Minecraft, æé¾):
                        </label>
                        <div class="flex gap-2">
                            <input v-model="userTheme" type="text" placeholder="è¼¸å…¥ä¸»é¡Œ..." class="flex-1 border-2 border-comic-purple rounded-xl px-4 py-2 font-bold focus:outline-none focus:ring-4 ring-purple-200">
                            <button @click="startAiLevel" :disabled="isAiLoading" class="bg-comic-purple text-white border-2 border-comic-black rounded-xl px-4 font-bold shadow-comic hover:scale-105 active:shadow-none active:translate-y-1 transition-all whitespace-nowrap">
                                GO!
                            </button>
                        </div>
                    </div>

                    <!-- AI éš¨æ©Ÿé—œå¡æŒ‰éˆ• (Omni-Box) -->
                    <button @click="startAiLevel" class="w-full bg-comic-black text-white border-4 border-gray-600 p-4 rounded-2xl shadow-comic hover:scale-[1.02] active:scale-95 transition-all mb-6 flex items-center justify-between group relative overflow-hidden">
                        <div class="absolute inset-0 bg-white opacity-10 group-hover:opacity-20 transition-opacity"></div>
                        <div class="flex items-center gap-3 relative z-10">
                            <div class="bg-white text-comic-black w-12 h-12 rounded-full border-2 border-gray-500 flex items-center justify-center text-2xl animate-spin-slow" style="animation-duration: 3s">ğŸ²</div>
                            <div class="text-left">
                                <div class="font-comic text-xl text-comic-yellow">MYSTERY CHALLENGE</div>
                                <div class="text-sm font-bold text-gray-300">éš¨æ©ŸæŠ€èƒ½ + éš¨æ©Ÿä¸»é¡Œ</div>
                            </div>
                        </div>
                        <i class="fa-solid fa-bolt text-4xl text-comic-yellow relative z-10 group-hover:scale-125 transition-transform"></i>
                    </button>

                    <div class="grid grid-cols-2 gap-4 flex-1 content-start">
                        <!-- è½ -->
                        <button @click="startSkill('listening')" class="aspect-square bg-comic-yellow border-4 border-comic-black rounded-2xl shadow-comic hover:scale-[1.02] active:scale-95 transition-all flex flex-col items-center justify-center gap-2 group">
                            <div class="bg-white border-2 border-comic-black rounded-full w-12 h-12 flex items-center justify-center text-2xl group-hover:rotate-12 transition-transform">ğŸ‘‚</div>
                            <span class="font-bold text-lg">Listening</span>
                            <span class="text-xs font-bold bg-white px-2 rounded border border-comic-black">è½åŠ›ç‰¹è¨“</span>
                        </button>

                        <!-- èªª -->
                        <button @click="startSkill('speaking')" class="aspect-square bg-comic-red border-4 border-comic-black rounded-2xl shadow-comic hover:scale-[1.02] active:scale-95 transition-all flex flex-col items-center justify-center gap-2 group">
                            <div class="bg-white border-2 border-comic-black rounded-full w-12 h-12 flex items-center justify-center text-2xl group-hover:-rotate-12 transition-transform">ğŸ‘„</div>
                            <span class="font-bold text-lg text-white">Speaking</span>
                            <span class="text-xs font-bold bg-white px-2 rounded border border-comic-black">å£èªªæŒ‘æˆ°</span>
                        </button>

                        <!-- è®€ -->
                        <button @click="startSkill('reading')" class="aspect-square bg-comic-blue border-4 border-comic-black rounded-2xl shadow-comic hover:scale-[1.02] active:scale-95 transition-all flex flex-col items-center justify-center gap-2 group">
                            <div class="bg-white border-2 border-comic-black rounded-full w-12 h-12 flex items-center justify-center text-2xl group-hover:rotate-12 transition-transform">ğŸ“–</div>
                            <span class="font-bold text-lg text-white">Reading</span>
                            <span class="text-xs font-bold bg-white px-2 rounded border border-comic-black">é–±è®€æ¸¬é©—</span>
                        </button>

                        <!-- å¯« -->
                        <button @click="startSkill('writing')" class="aspect-square bg-comic-green border-4 border-comic-black rounded-2xl shadow-comic hover:scale-[1.02] active:scale-95 transition-all flex flex-col items-center justify-center gap-2 group">
                            <div class="bg-white border-2 border-comic-black rounded-full w-12 h-12 flex items-center justify-center text-2xl group-hover:-rotate-12 transition-transform">âœï¸</div>
                            <span class="font-bold text-lg text-white">Writing</span>
                            <span class="text-xs font-bold bg-white px-2 rounded border border-comic-black">æ‹¼å­—é‡çµ„</span>
                        </button>
                    </div>
                </div>
            </transition>

            <!-- 3. éŠæˆ²é€²è¡Œç•«é¢ (Gameplay) -->
            <transition name="fade">
                <div v-if="currentScreen === 'game'" class="absolute inset-0 flex flex-col p-6 bg-[#F0F4F8]">
                    
                    <!-- é€²åº¦æ¢ -->
                    <div class="w-full bg-white border-2 border-comic-black h-4 rounded-full mb-6 relative overflow-hidden">
                        <div class="bg-comic-yellow h-full border-r-2 border-comic-black transition-all duration-500" :style="{ width: progress + '%' }"></div>
                    </div>

                    <!-- éŠæˆ²å¡ç‰‡å€åŸŸ -->
                    <div class="bg-white border-4 border-comic-black rounded-2xl p-6 shadow-comic flex-1 flex flex-col relative overflow-hidden">
                        
                        <!-- æŠ€èƒ½æ¨™ç±¤ -->
                        <div class="absolute top-0 right-0 bg-comic-black text-white px-4 py-1 rounded-bl-xl font-bold text-xs uppercase z-20">
                            {{ activeSkill }} MODE
                        </div>

                        <!-- é¡¯ç¤ºè‡ªè¨‚ä¸»é¡Œæ¨™ç±¤ (å¦‚æœæœ‰çš„è©±) -->
                        <div v-if="userTheme" class="absolute top-0 left-0 bg-comic-purple text-white px-4 py-1 rounded-br-xl font-bold text-xs uppercase z-20 border-r-2 border-b-2 border-comic-black">
                            Theme: {{ userTheme }}
                        </div>

                        <!-- A. è½åŠ›é¡Œå‹ (Listening) -->
                        <div v-if="activeSkill === 'listening'" class="flex-1 flex flex-col items-center justify-center text-center">
                            <button @click="playAudio(currentQuestion.text)" class="w-24 h-24 bg-comic-blue rounded-full border-4 border-comic-black flex items-center justify-center mb-6 shadow-comic hover:scale-105 transition-transform active:translate-y-[4px] active:shadow-none">
                                <i class="fa-solid fa-volume-high text-4xl text-white"></i>
                            </button>
                            <p class="text-gray-500 font-bold mb-8">é»æ“Šæ’­æ”¾ï¼Œé¸å‡ºè½åˆ°çš„å–®å­—ï¼</p>
                            
                            <div class="grid grid-cols-2 gap-4 w-full">
                                <button v-for="(opt, idx) in currentQuestion.options" :key="idx" @click="checkAnswer(idx)" 
                                    class="bg-white border-2 border-comic-black p-4 rounded-xl font-bold hover:bg-comic-yellow transition-colors text-lg shadow-comic-hover">
                                    {{ opt }}
                                </button>
                            </div>
                        </div>

                        <!-- B. å£èªªé¡Œå‹ (Speaking) -->
                        <div v-else-if="activeSkill === 'speaking'" class="flex-1 flex flex-col items-center justify-center text-center">
                            <h3 class="text-xl font-bold mb-2 text-gray-400">è«‹å¤§è²å”¸å‡ºï¼š</h3>
                            <div class="text-2xl font-black text-comic-black mb-8 border-b-4 border-comic-green inline-block pb-2 leading-relaxed">
                                "{{ currentQuestion.text }}"
                            </div>
                            
                            <div class="h-10 mb-4 flex items-center justify-center voice-wave" v-if="isRecording">
                                <span style="animation-delay: 0.1s"></span><span style="animation-delay: 0.2s"></span><span style="animation-delay: 0.3s"></span><span style="animation-delay: 0.4s"></span><span style="animation-delay: 0.5s"></span>
                            </div>
                            <div class="h-10 mb-4 text-gray-400 font-bold" v-else>
                                {{ feedbackMessage || 'æŒ‰ä½éº¥å…‹é¢¨èªªè©±' }}
                            </div>

                            <button @mousedown="startRecording" @mouseup="stopRecording" @touchstart="startRecording" @touchend="stopRecording"
                                :class="isRecording ? 'bg-comic-red scale-95' : 'bg-white'"
                                class="w-20 h-20 border-4 border-comic-black rounded-full flex items-center justify-center text-3xl shadow-comic transition-all select-none touch-manipulation">
                                <i class="fa-solid fa-microphone" :class="isRecording ? 'text-white' : 'text-comic-black'"></i>
                            </button>
                        </div>

                        <!-- C. é–±è®€é¡Œå‹ (Reading) -->
                        <div v-else-if="activeSkill === 'reading'" class="flex-1 flex flex-col">
                            <div class="bg-gray-100 p-4 rounded-xl border-2 border-comic-black mb-6 relative">
                                <i class="fa-solid fa-quote-left text-3xl text-gray-300 absolute top-2 left-2"></i>
                                <p class="font-bold text-lg text-center z-10 relative pt-2 leading-relaxed">{{ currentQuestion.question }}</p>
                            </div>
                            
                            <div class="space-y-3">
                                <button v-for="(opt, idx) in currentQuestion.options" :key="idx" @click="checkAnswer(idx)" 
                                    class="w-full bg-white border-2 border-comic-black p-3 rounded-xl font-bold text-left hover:bg-comic-blue hover:text-white transition-colors flex items-center gap-3 group">
                                    <span class="w-8 h-8 rounded-full border-2 border-comic-black flex items-center justify-center bg-gray-100 group-hover:bg-white text-comic-black">{{ ['A','B','C','D'][idx] }}</span>
                                    {{ opt }}
                                </button>
                            </div>
                        </div>

                        <!-- D. å¯«ä½œ/æ‹¼å­—é¡Œå‹ (Writing) -->
                        <div v-else-if="activeSkill === 'writing'" class="flex-1 flex flex-col items-center">
                            <p class="text-gray-500 font-bold mb-4">é‡çµ„å¥å­ / æ‹¼å¯«å–®å­—</p>
                            <div class="w-full bg-gray-100 border-b-4 border-comic-black p-4 mb-6 min-h-[80px] rounded-xl flex flex-wrap gap-2 items-center justify-center">
                                <transition-group name="fade">
                                    <span v-for="(word, idx) in userSentence" :key="word.id" @click="removeWord(idx)" class="bg-comic-blue text-white px-3 py-1 rounded-lg border-2 border-comic-black font-bold cursor-pointer hover:bg-red-500">
                                        {{ word.text }}
                                    </span>
                                </transition-group>
                                <span v-if="userSentence.length === 0" class="text-gray-400 text-sm">é»æ“Šä¸‹æ–¹å–®å­—å¡é‡çµ„</span>
                            </div>

                            <div class="flex flex-wrap gap-3 justify-center">
                                <button v-for="(word, idx) in currentQuestion.scrambled" :key="idx" 
                                    @click="addWord(word)"
                                    :disabled="word.used"
                                    :class="word.used ? 'opacity-20 scale-90' : 'hover:scale-105 hover:-rotate-2'"
                                    class="bg-white border-2 border-comic-black px-4 py-2 rounded-lg font-bold shadow-comic-hover transition-all">
                                    {{ word.text }}
                                </button>
                            </div>
                            
                            <div class="mt-auto w-full">
                                <button @click="checkWriting" class="w-full bg-comic-green text-white border-4 border-comic-black py-3 rounded-xl font-bold text-xl shadow-comic active:shadow-none active:translate-y-[4px]">
                                    ç¢ºèªç­”æ¡ˆ (Check)
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </transition>

            <!-- 4. çµç®—å½ˆçª— (Feedback Modal) -->
            <transition name="fade">
                <div v-if="showResult" class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm">
                    <div class="bg-white border-4 border-comic-black rounded-3xl p-6 w-full max-w-sm text-center shadow-comic-lg relative overflow-hidden animate-pow flex flex-col max-h-[90vh]">
                        <div class="absolute -top-10 -right-10 w-24 h-24 bg-comic-yellow rounded-full z-0"></div>
                        
                        <div class="relative z-10 flex flex-col h-full overflow-y-auto">
                            <i v-if="isCorrect" class="fa-solid fa-face-grin-stars text-6xl text-comic-green mb-4 drop-shadow-sm"></i>
                            <i v-else class="fa-solid fa-face-dizzy text-6xl text-comic-red mb-4 drop-shadow-sm"></i>
                            
                            <h2 class="text-3xl font-comic tracking-wide mb-2">
                                {{ isCorrect ? 'AWESOME!' : 'OOPS!' }}
                            </h2>
                            
                            <p class="text-lg font-bold mb-4 text-gray-700">
                                {{ isCorrect ? 'ç­”å°äº†ï¼ä½ çœŸæ£’ï¼' : 'å†è©¦ä¸€æ¬¡ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š' }}
                                <br>
                                <span v-if="!isCorrect" class="text-comic-red">{{ correctAnswerText }}</span>
                            </p>

                            <!-- AI è§£èªªå€åŸŸ -->
                            <div v-if="aiExplanation" class="bg-blue-50 border-2 border-blue-200 rounded-xl p-3 mb-4 text-left text-sm">
                                <div class="font-bold text-blue-600 mb-1 flex items-center gap-1"><i class="fa-solid fa-robot"></i> AI Sensei Says:</div>
                                <div v-html="renderMarkdown(aiExplanation)" class="prose prose-sm max-w-none text-gray-700 leading-relaxed"></div>
                            </div>

                            <div class="mt-auto space-y-3">
                                <!-- AI è§£èªªæŒ‰éˆ• (å¦‚æœé‚„æ²’è§£èªª) -->
                                <button v-if="!aiExplanation" @click="askAiTeacher" :disabled="isAiLoading" class="w-full bg-comic-purple text-white font-bold py-3 rounded-xl border-2 border-comic-black shadow-[4px_4px_0px_#1A1A1A] active:shadow-none active:translate-y-[4px] transition-all flex items-center justify-center gap-2">
                                    <span v-if="isAiLoading" class="comic-loader !w-5 !h-5 !border-2 !border-white !border-b-transparent"></span>
                                    <span v-else>âœ¨ è«‹ AI è¶…äººè¬›è§£ (Ask AI)</span>
                                </button>

                                <button @click="nextQuestion" class="w-full bg-comic-black text-white font-bold py-3 rounded-xl border-2 border-comic-black shadow-[4px_4px_0px_#888] active:shadow-none active:translate-y-[4px] transition-all">
                                    ç¹¼çºŒæŒ‘æˆ° Next â”
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- è¨­å®šå½ˆçª— (Settings Modal) -->
            <transition name="fade">
                <div v-if="showSettings" class="absolute inset-0 z-[70] flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm">
                    <div class="bg-white border-4 border-comic-black rounded-3xl p-6 w-full max-w-sm text-center shadow-comic-lg relative overflow-hidden animate-pow">
                        <div class="relative z-10">
                            <h2 class="text-2xl font-comic tracking-wide mb-4 text-comic-black">SETTINGS</h2>
                            
                            <div class="text-left mb-6">
                                <label class="block text-comic-black font-bold mb-2">Gemini API Key</label>
                                <input v-model="userApiKey" type="password" placeholder="Paste your API key here..." class="w-full border-2 border-comic-black rounded-xl px-4 py-3 font-bold focus:outline-none focus:ring-4 ring-comic-yellow">
                                <p class="text-xs text-gray-500 mt-2 font-bold">
                                    <i class="fa-solid fa-lock"></i> Key åªæœƒå„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ä¸­
                                </p>
                            </div>

                            <div class="flex gap-2">
                                <button @click="saveApiKey" class="flex-1 bg-comic-green text-white font-bold py-3 rounded-xl border-2 border-comic-black shadow-comic active:shadow-none active:translate-y-[4px] transition-all">
                                    å„²å­˜ (Save)
                                </button>
                                <button @click="showSettings = false" class="flex-1 bg-gray-200 text-comic-black font-bold py-3 rounded-xl border-2 border-comic-black shadow-comic active:shadow-none active:translate-y-[4px] transition-all">
                                    é—œé–‰ (Close)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

        </main>
    </div>

    <script>
        const { createApp } = Vue;
        // æ³¨æ„ï¼šç‚ºäº† GitHub Pages å®‰å…¨ï¼Œé€™è£¡ç•™ç©ºã€‚è«‹åœ¨ç¶²é å³ä¸Šè§’ã€Œè¨­å®šã€ä¸­è¼¸å…¥ Keyã€‚
        const apiKey = ""; 

        createApp({
            data() {
                return {
                    currentScreen: 'home', 
                    difficulty: null, 
                    activeSkill: null, 
                    score: 0,
                    currentIndex: 0,
                    showResult: false,
                    isCorrect: false,
                    correctAnswerText: '',
                    
                    // AI ç›¸é—œ
                    isAiLoading: false,
                    aiExplanation: '',
                    userTheme: '', 
                    
                    // è¨­å®šç›¸é—œ
                    showSettings: false,
                    userApiKey: '', // ç”¨æˆ¶è‡ªå·±è¼¸å…¥çš„ Key
                    
                    // Speaking ç›¸é—œ
                    isRecording: false,
                    feedbackMessage: '',
                    recognition: null,

                    // Writing ç›¸é—œ
                    userSentence: [],
                    
                    // TTS è²éŸ³åˆ—è¡¨
                    voices: [],

                    // å…§å»ºé¡Œåº«
                    database: {
                        easy: {
                            listening: [{ type: 'listen', text: 'Apple', options: ['Banana', 'Apple', 'Orange', 'Grape'], answer: 1 }],
                            speaking: [{ type: 'speak', text: 'Good morning' }],
                            reading: [{ type: 'read', question: 'The sun is ______.', options: ['hot', 'cold', 'wet', 'dark'], answer: 0 }],
                            writing: [{ type: 'write', text: 'I like dogs', scrambled: ['like', 'dogs', 'I'] }]
                        },
                        hard: {
                            listening: [{ type: 'listen', text: 'Environment', options: ['Government', 'Environment', 'Experiment', 'Equipment'], answer: 1 }],
                            speaking: [{ type: 'speak', text: 'Where is the library' }],
                            reading: [{ type: 'read', question: 'Before you cross the street, you must ______.', options: ['look left', 'close eyes', 'run fast', 'jump high'], answer: 0 }],
                            writing: [{ type: 'write', text: 'What time is it', scrambled: ['is', 'time', 'What', 'it'] }]
                        }
                    },
                    currentQuestions: []
                }
            },
            mounted() {
                const loadVoices = () => { this.voices = window.speechSynthesis.getVoices(); };
                window.speechSynthesis.onvoiceschanged = loadVoices;
                loadVoices();

                // è®€å–å„²å­˜çš„ API Key
                const savedKey = localStorage.getItem('gemini_key');
                if (savedKey) {
                    this.userApiKey = savedKey;
                }
            },
            computed: {
                currentQuestion() { return this.currentQuestions[this.currentIndex]; },
                progress() { return ((this.currentIndex) / this.currentQuestions.length) * 100; }
            },
            methods: {
                renderMarkdown(text) { return marked.parse(text); },
                
                // å„²å­˜ API Key
                saveApiKey() {
                    localStorage.setItem('gemini_key', this.userApiKey);
                    this.showSettings = false;
                    alert("API Key å·²å„²å­˜ï¼");
                },

                // --- Gemini API å‘¼å« ---
                async callGemini(prompt, isJson = false) {
                    // å„ªå…ˆä½¿ç”¨ç”¨æˆ¶è¼¸å…¥çš„ Keyï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ç’°å¢ƒ Key (é è¦½ç”¨)
                    const keyToUse = this.userApiKey || apiKey;

                    if (!keyToUse) { 
                        alert("è«‹å…ˆåœ¨è¨­å®š (âš™ï¸) ä¸­è¼¸å…¥ä½ çš„ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ï¼"); 
                        this.showSettings = true;
                        return null; 
                    }
                    try {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`;
                        const payload = {
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: isJson ? { responseMimeType: "application/json" } : {}
                        };
                        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        return data.candidates[0].content.parts[0].text;
                    } catch (error) {
                        console.error("Gemini API Error:", error);
                        alert("AI é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢ºï¼");
                        return null;
                    }
                },

                // ğŸŒŸ ç”Ÿæˆå…¨æ–¹ä½ AI é—œå¡
                async startAiLevel() {
                    this.isAiLoading = true;
                    const diffLevel = this.difficulty === 'easy' ? 'elementary school student (A1 level)' : 'junior high student (A2/B1 level)';
                    const theme = this.userTheme ? this.userTheme : 'funny cartoon adventures';
                    
                    const prompt = `Generate a single English learning question for a ${diffLevel}.
                    Theme: "${theme}".
                    Task: Randomly choose ONE skill from ['listen', 'speak', 'read', 'write'] and generate a question for it.
                    
                    Return ONLY a JSON object with this specific structure based on the chosen skill:
                    
                    1. If 'listen': { "type": "listen", "text": "TargetWord", "options": ["Wrong1", "TargetWord", "Wrong2", "Wrong3"], "answer": 1 }
                    
                    2. If 'speak': { "type": "speak", "text": "A simple sentence related to the theme for the user to read aloud." }
                    
                    3. If 'read': { "type": "read", "question": "A short sentence with a blank ______ related to the theme.", "options": ["OptionA", "OptionB", "OptionC", "OptionD"], "answer": 0 }
                    
                    4. If 'write': { "type": "write", "text": "A sentence to unscramble", "scrambled": ["word1", "word2", "word3", ...] }
                    
                    Make the content fun and engaging for kids.`;

                    const result = await this.callGemini(prompt, true);
                    this.isAiLoading = false;

                    if (result) {
                        try {
                            const newQuestion = JSON.parse(result);
                            if (newQuestion.type === 'write') {
                                newQuestion.scrambled = newQuestion.scrambled.map((word, id) => ({ text: word, id: id, used: false }));
                            }
                            this.activeSkill = newQuestion.type === 'listen' ? 'listening' : 
                                               newQuestion.type === 'speak' ? 'speaking' :
                                               newQuestion.type === 'read' ? 'reading' : 'writing';
                                               
                            this.currentQuestions = [newQuestion];
                            this.currentIndex = 0;
                            this.currentScreen = 'game';
                            this.userSentence = [];
                            this.feedbackMessage = '';
                        } catch (e) {
                            console.error("JSON Parse Error", e);
                            alert("AI ç”Ÿæˆçš„è³‡æ–™æ ¼å¼æœ‰èª¤ï¼Œè«‹é‡è©¦ã€‚");
                        }
                    }
                },

                // AI è€å¸«è¬›è§£
                async askAiTeacher() {
                    this.isAiLoading = true;
                    const q = this.currentQuestion;
                    const prompt = `You are a superhero mentor for kids. The child answered a question about "${this.userTheme || 'general knowledge'}".
                    Question: "${q.question || q.text}"
                    Correct Answer: "${q.options ? q.options[q.answer] : q.text}"
                    Please explain the answer in Traditional Chinese. Be funny, use emojis, and encourage them! Keep it short.`;

                    const explanation = await this.callGemini(prompt, false);
                    this.isAiLoading = false;
                    if (explanation) this.aiExplanation = explanation;
                },

                // --- åŸºç¤é‚è¼¯ ---
                selectDifficulty(level) {
                    this.difficulty = level;
                    this.currentScreen = 'skill-map';
                },
                goHome() {
                    this.currentScreen = 'home';
                    this.score = 0;
                    this.difficulty = null;
                    this.userTheme = '';
                },
                startSkill(skill) {
                    this.activeSkill = skill;
                    let rawQ = JSON.parse(JSON.stringify(this.database[this.difficulty || 'easy'][skill]));
                    if(skill === 'writing') {
                        rawQ.forEach(q => {
                            q.scrambled = q.scrambled.map((word, id) => ({ text: word, id: id, used: false }));
                        });
                    }
                    this.currentQuestions = rawQ;
                    this.currentIndex = 0;
                    this.currentScreen = 'game';
                    this.userSentence = [];
                    this.aiExplanation = '';
                },
                playAudio(text) {
                    window.speechSynthesis.cancel();
                    let utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.85;
                    if (this.voices.length > 0) {
                        const v = this.voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
                        if (v) utterance.voice = v;
                    }
                    speechSynthesis.speak(utterance);
                },
                startRecording() {
                    if (!('webkitSpeechRecognition' in window)) { alert("è«‹ä½¿ç”¨ Chrome ç€è¦½å™¨"); return; }
                    this.isRecording = true;
                    this.feedbackMessage = 'Listening...';
                    this.recognition = new webkitSpeechRecognition();
                    this.recognition.lang = 'en-US';
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript.toLowerCase();
                        const target = this.currentQuestion.text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
                        if (transcript.includes(target)) this.handleResult(true, `You said: "${transcript}"`);
                        else this.handleResult(false, `Heard: "${transcript}"`);
                    };
                    this.recognition.onend = () => { this.isRecording = false; };
                    this.recognition.start();
                },
                stopRecording() { if (this.recognition) this.recognition.stop(); this.isRecording = false; },
                addWord(w) { w.used = true; this.userSentence.push(w); },
                removeWord(idx) { 
                    const w = this.userSentence[idx];
                    const orig = this.currentQuestion.scrambled.find(o => o.id === w.id);
                    if(orig) orig.used = false;
                    this.userSentence.splice(idx, 1);
                },
                checkWriting() {
                    const s = this.userSentence.map(w => w.text).join(' ');
                    this.handleResult(s === this.currentQuestion.text, this.currentQuestion.text);
                },
                checkAnswer(idx) {
                    this.handleResult(idx === this.currentQuestion.answer, this.currentQuestion.options[this.currentQuestion.answer]);
                },
                handleResult(isCorrect, text) {
                    this.isCorrect = isCorrect;
                    this.correctAnswerText = text;
                    this.showResult = true;
                    this.aiExplanation = '';
                    if (isCorrect) {
                        this.score += 10;
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#FFD93D', '#FF6B6B', '#4D96FF'] });
                    }
                },
                nextQuestion() {
                    this.showResult = false;
                    this.userSentence = [];
                    if (this.currentIndex < this.currentQuestions.length - 1) this.currentIndex++;
                    else { alert("Challenge Complete!"); this.currentScreen = 'skill-map'; }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
