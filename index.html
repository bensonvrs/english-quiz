import React, { useState, useEffect, useRef } from 'react';
import { Volume2, Mic, Edit3, BookOpen, ChevronRight, Trophy, Star, RefreshCw, Check, X, Medal, Sparkles, Loader } from 'lucide-react';

// é è¨­çš„çƒå“¡å¡è³‡æ–™ (ç•¶ AI å°šæœªç”Ÿæˆæ™‚ä½¿ç”¨)
const defaultCards = [
  {
    id: 1,
    player: "Shohei Ohtani",
    team: "Dodgers",
    image: "âš¾ï¸", 
    color: "from-blue-600 to-blue-800",
    sentence: "Ohtani hits a massive home run to win the game.",
    translation: "å¤§è°·ç¿”å¹³æ“Šå‡ºä¸€æ”¯å·¨å¤§çš„å…¨å£˜æ‰“ï¼Œè´å¾—äº†æ¯”è³½ã€‚",
    keywords: ["hits", "massive", "win"],
    grammarFocus: "Subject (Ohtani) + Verb (hits) + Object (home run)"
  },
  {
    id: 2,
    player: "Aaron Judge",
    team: "Yankees",
    image: "ğŸŸï¸",
    color: "from-gray-700 to-gray-900",
    sentence: "The tall player catches the ball near the wall.",
    translation: "é‚£ä½é«˜å¤§çš„çƒå“¡åœ¨ç‰†é‚Šæ¥ä½äº†çƒã€‚",
    keywords: ["tall", "catches", "near"],
    grammarFocus: "Adjective (tall) describes the Noun (player)"
  },
  {
    id: 3,
    player: "Jason & Toby",
    team: "Team Wei",
    image: "ğŸ§¢",
    color: "from-red-600 to-red-800",
    sentence: "We practice baseball every weekend with our father.",
    translation: "æˆ‘å€‘æ¯å€‹é€±æœ«éƒ½è·Ÿçˆ¸çˆ¸ä¸€èµ·ç·´ç¿’æ£’çƒã€‚",
    keywords: ["practice", "weekend", "father"],
    grammarFocus: "Frequency Adverb (every weekend)"
  }
];

const BaseballApp = () => {
  // ä½¿ç”¨ State ç®¡ç†å¡ç‰‡åˆ—è¡¨ï¼Œé€™æ¨£å¯ä»¥åŠ å…¥ AI ç”Ÿæˆçš„æ–°å¡ç‰‡
  const [cards, setCards] = useState(defaultCards);
  const [currentCardIdx, setCurrentCardIdx] = useState(0);
  const [mode, setMode] = useState('read'); // read, listen, speak, write
  const [score, setScore] = useState(0);
  const [userInput, setUserInput] = useState('');
  const [feedback, setFeedback] = useState(null); // 'correct', 'incorrect', null
  const [isListening, setIsListening] = useState(false);
  const [transcript, setTranscript] = useState('');
  
  // AI ç›¸é—œ State
  const [isLoadingAI, setIsLoadingAI] = useState(false);
  const [aiCoachTip, setAiCoachTip] = useState(null); // å„²å­˜ AI æ•™ç·´çš„é¡å¤–è§£èªª
  
  const currentCard = cards[currentCardIdx];
  const apiKey = ""; // Runtime ç’°å¢ƒæœƒè‡ªå‹•æä¾›ï¼Œä¸éœ€è¦å¡«å¯«

  // --- Gemini API å‘¼å«å‡½æ•¸ ---
  const callGemini = async (prompt, isJson = false) => {
    setIsLoadingAI(true);
    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            // å¦‚æœéœ€è¦ JSON æ ¼å¼ï¼Œå¯ä»¥åŠ å…¥ generationConfig (ä½†ç›®å‰ç°¡å–®ç”¨ Prompt å¼•å°å³å¯)
            generationConfig: isJson ? { responseMimeType: "application/json" } : {}
          })
        }
      );

      if (!response.ok) throw new Error('API call failed');
      
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      return text;
    } catch (error) {
      console.error("Gemini Error:", error);
      alert("AI çƒæ¢å¿™ç·šä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
      return null;
    } finally {
      setIsLoadingAI(false);
    }
  };

  // --- åŠŸèƒ½ 1: AI ç”Ÿæˆæ–°çƒå“¡å¡ (Scout New Player) ---
  const handleScoutNewPlayer = async () => {
    const prompt = `
      You are a baseball English teacher for kids. Generate a NEW, UNIQUE baseball player card data in JSON format.
      Target Audience: GEPT Elementary level (Kids aged 9-10).
      Content Requirements:
      1. Player: A famous MLB player name (current or legend, random).
      2. Team: The player's team name.
      3. Sentence: A simple English sentence about a baseball action (e.g., pitching, running, sliding, cheering). Use simple grammar suitable for kids.
      4. Translation: Traditional Chinese translation.
      5. Keywords: An array of 2-3 important words from the sentence.
      6. GrammarFocus: A very short, simple grammar explanation using baseball analogies (e.g., "The verb is the pitcher").
      7. Image: A relevant single emoji (e.g., ğŸ§¤, ğŸ§¢, ğŸ‘Ÿ, ğŸŒ­).
      8. Color: A Tailwind CSS gradient string (e.g., "from-green-600 to-green-800").

      Response Format (JSON only):
      {
        "player": "Name",
        "team": "Team",
        "image": "Emoji",
        "color": "Tailwind Gradient",
        "sentence": "English Sentence",
        "translation": "Chinese Translation",
        "keywords": ["word1", "word2"],
        "grammarFocus": "Grammar explanation"
      }
    `;

    const result = await callGemini(prompt, true);
    if (result) {
      try {
        const newCardData = JSON.parse(result);
        const newCard = { ...newCardData, id: Date.now() }; // çµ¦äºˆå”¯ä¸€ ID
        setCards([...cards, newCard]);
        setCurrentCardIdx(cards.length); // åˆ‡æ›åˆ°æ–°å¡ç‰‡
        resetState();
        playSound('scout');
      } catch (e) {
        console.error("Parse Error", e);
        alert("çƒæ¢å ±å‘Šè§£æå¤±æ•—ï¼Œè«‹é‡è©¦ï¼");
      }
    }
  };

  // --- åŠŸèƒ½ 2: AI æ•™ç·´è¬›è§£ (Coach's Tip) ---
  const handleAskCoach = async () => {
    if (aiCoachTip) return; // å¦‚æœå·²ç¶“æœ‰è§£é‡‹ï¼Œå°±ä¸é‡è¤‡å•

    const prompt = `
      The user is a 10-year-old kid learning English.
      Sentence: "${currentCard.sentence}"
      Task: Explain the grammar or vocabulary of this sentence using a FUN BASEBALL ANALOGY.
      Example: "Here, 'He' is the batter (Subject), and 'hits' is the swing (Verb)!"
      Keep it short, encouraging, and in Traditional Chinese (ç¹é«”ä¸­æ–‡).
      Start with "âš¾ï¸ æ•™ç·´èªªï¼š"
    `;

    const result = await callGemini(prompt);
    if (result) {
      setAiCoachTip(result);
    }
  };

  // --- è½åŠ›åŠŸèƒ½ (TTS) ---
  const speakSentence = () => {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(currentCard.sentence);
      utterance.lang = 'en-US';
      utterance.rate = 0.9; // ç¨å¾®æ”¾æ…¢èªé€Ÿé©åˆå°æœ‹å‹
      window.speechSynthesis.speak(utterance);
    } else {
      alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç™¼éŸ³åŠŸèƒ½ï¼Œè«‹ç”¨ Chrome è©¦è©¦ï¼");
    }
  };

  // --- å£èªªåŠŸèƒ½ (STT) ---
  const startListening = () => {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ç”¨ Chrome (æ¡Œæ©Ÿ/Android)ï¼");
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;

    setIsListening(true);
    setTranscript('Listening...');
    setFeedback(null);

    recognition.onresult = (event) => {
      const last = event.results.length - 1;
      const text = event.results[last][0].transcript;
      setTranscript(text);
      checkSpeaking(text);
    };

    recognition.onend = () => {
      setIsListening(false);
    };

    recognition.onerror = (event) => {
      console.error(event.error);
      setIsListening(false);
      setTranscript('è½ä¸æ¸…æ¥šï¼Œå†è©¦ä¸€æ¬¡ï¼(Try again)');
    };

    recognition.start();
  };

  const checkSpeaking = (text) => {
    // ç°¡å–®çš„æ¯”å°é‚è¼¯ (å»é™¤æ¨™é»ç¬¦è™Ÿèˆ‡å¤§å°å¯«)
    const target = currentCard.sentence.toLowerCase().replace(/[.,!]/g, '');
    const input = text.toLowerCase().replace(/[.,!]/g, '');
    
    // åªè¦æœ‰ 60% ç›¸ä¼¼å°±ç®—éé—œ (é¼“å‹µæ€§è³ª)
    if (input.includes(target) || input === target || calculateSimilarity(input, target) > 0.6) {
      setFeedback('correct');
      setScore(s => s + 20);
      playSound('hit');
    } else {
      setFeedback('incorrect');
      playSound('miss');
    }
  };

  // ç°¡å–®çš„å­—ä¸²ç›¸ä¼¼åº¦ç®—æ³• (Levenshtein distance ç°¡åŒ–ç‰ˆæ¦‚æ¦‚å¿µ)
  const calculateSimilarity = (s1, s2) => {
    let longer = s1;
    let shorter = s2;
    if (s1.length < s2.length) { longer = s2; shorter = s1; }
    const longerLength = longer.length;
    if (longerLength === 0) return 1.0;
    return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
  };
  const editDistance = (s1, s2) => {
    s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
    const costs = new Array();
    for (let i = 0; i <= s1.length; i++) {
      let lastValue = i;
      for (let j = 0; j <= s2.length; j++) {
        if (i == 0) costs[j] = j;
        else {
          if (j > 0) {
            let newValue = costs[j - 1];
            if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
            costs[j - 1] = lastValue;
            lastValue = newValue;
          }
        }
      }
      if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
  }

  // --- å¯«ä½œåŠŸèƒ½ ---
  const checkWriting = () => {
    // æª¢æŸ¥æ˜¯å¦åŒ…å«é—œéµå­—
    const targetKeywords = currentCard.keywords;
    const inputWords = userInput.toLowerCase().split(' ');
    const isMatch = targetKeywords.every(k => inputWords.some(w => w.includes(k.toLowerCase())));

    if (isMatch) {
      setFeedback('correct');
      setScore(s => s + 20);
      playSound('homerun');
    } else {
      setFeedback('incorrect');
      playSound('miss');
    }
  };

  // ç°¡å–®éŸ³æ•ˆæ¨¡æ“¬
  const playSound = (type) => {
    // é€™è£¡åªæ˜¯ç¤ºæ„ï¼Œå¯¦å‹™ä¸Šå¯æ›è¼‰ mp3
    console.log(`Playing sound: ${type}`);
  };

  const nextCard = () => {
    if (currentCardIdx < cards.length - 1) {
      setCurrentCardIdx(c => c + 1);
      resetState();
    } else {
      alert("é è¨­å¡ç‰‡è¨“ç·´å®Œæˆï¼è«‹æŒ‰ã€Œâœ¨ æ´¾å‡ºçƒæ¢ã€ä¾†ç”Ÿæˆæ–°æŒ‘æˆ°ï¼");
    }
  };

  const resetState = () => {
    setMode('read');
    setFeedback(null);
    setUserInput('');
    setTranscript('');
    setIsListening(false);
    setAiCoachTip(null); // é‡ç½®æ•™ç·´æç¤º
  };

  // --- UI çµ„ä»¶ ---
  return (
    <div className="min-h-screen bg-green-800 font-sans text-gray-100 flex flex-col items-center p-4 relative overflow-hidden">
      {/* èƒŒæ™¯è£é£¾ (æ£’çƒå ´è‰çš®æ„Ÿ) */}
      <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(#ffffff 2px, transparent 2px)', backgroundSize: '30px 30px' }}></div>
      
      {/* é ‚éƒ¨è¨˜åˆ†æ¿ */}
      <div className="w-full max-w-3xl bg-gray-900 border-4 border-gray-700 rounded-xl p-4 mb-6 shadow-2xl z-10 flex justify-between items-center relative">
        <div className="flex items-center gap-3">
          <div className="bg-yellow-500 p-2 rounded-lg text-gray-900 font-black">HOME</div>
          <div className="text-4xl font-mono text-red-500 font-bold tracking-widest">{score.toString().padStart(3, '0')}</div>
        </div>
        <div className="text-center">
          <h1 className="text-lg md:text-2xl font-black text-white tracking-tighter uppercase italic">
            Wei Bros Stadium
          </h1>
          <p className="text-xs text-gray-400">AI-Powered Training Camp</p>
        </div>
        <div className="flex items-center gap-2">
          <div className="flex flex-col items-end">
            <span className="text-xs text-gray-400">INNING</span>
            <span className="text-2xl font-mono text-yellow-400">{currentCardIdx + 1}</span>
          </div>
        </div>
      </div>

      {/* åŠŸèƒ½åˆ—: ç”Ÿæˆæ–°å¡ç‰‡ */}
      <div className="w-full max-w-md mb-4 flex justify-end z-20">
        <button 
          onClick={handleScoutNewPlayer}
          disabled={isLoadingAI}
          className="flex items-center gap-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition disabled:opacity-50"
        >
          {isLoadingAI ? <Loader className="animate-spin" size={18} /> : <Sparkles size={18} className="text-yellow-300" />}
          {isLoadingAI ? "Scouting..." : "æ´¾å‡º AI çƒæ¢ (New Card)"}
        </button>
      </div>

      {/* ä¸»å¡ç‰‡å€ */}
      <div className="w-full max-w-md relative z-10 perspective-1000">
        <div className={`relative bg-gradient-to-br ${currentCard.color} rounded-3xl shadow-2xl border-4 border-white/20 overflow-hidden transition-all duration-500`}>
          
          {/* çƒå“¡å¡é ­åƒå€ */}
          <div className="h-48 flex items-center justify-center bg-black/20 relative">
             <div className="text-8xl animate-bounce-slow">{currentCard.image}</div>
             <div className="absolute bottom-2 left-4 text-white font-black text-3xl italic drop-shadow-lg">
               {currentCard.player}
             </div>
             <div className="absolute top-4 right-4 bg-white text-gray-900 text-xs font-bold px-2 py-1 rounded uppercase">
               {currentCard.team}
             </div>
          </div>

          {/* å…§å®¹å€ */}
          <div className="p-6 bg-white text-gray-800 min-h-[300px]">
            
            {/* Mode: READ (é–±è®€/æˆ°è¡“åˆ†æ) */}
            {mode === 'read' && (
              <div className="animate-fade-in">
                <div className="flex items-center gap-2 mb-2 text-blue-600 font-bold uppercase text-sm">
                  <BookOpen size={16} /> Scouting Report
                </div>
                <h2 className="text-2xl font-bold mb-4 leading-relaxed">{currentCard.sentence}</h2>
                <p className="text-gray-500 mb-6 border-l-4 border-yellow-400 pl-3 italic">
                  {currentCard.translation}
                </p>
                <div className="bg-gray-100 p-3 rounded-lg text-sm mb-4">
                  <strong className="text-gray-700 block mb-1">âš¾ï¸ Coach's Note:</strong>
                  {currentCard.grammarFocus}
                </div>

                {/* AI æ•™ç·´æŒ‰éˆ• */}
                {!aiCoachTip ? (
                  <button 
                    onClick={handleAskCoach}
                    disabled={isLoadingAI}
                    className="w-full flex items-center justify-center gap-2 bg-indigo-100 text-indigo-700 py-2 rounded-lg font-bold hover:bg-indigo-200 transition"
                  >
                    {isLoadingAI ? <Loader className="animate-spin" size={16} /> : <Sparkles size={16} />}
                    æ•™ç·´ï¼Œæˆ‘ä¸æ‡‚é€™å€‹æˆ°è¡“ï¼ (Ask AI)
                  </button>
                ) : (
                  <div className="bg-indigo-50 border border-indigo-200 p-3 rounded-lg text-sm text-indigo-800 animate-fade-in">
                    {aiCoachTip}
                  </div>
                )}
              </div>
            )}

            {/* Mode: LISTEN (è½åŠ›/æ•æ‰‹è¨“ç·´) */}
            {mode === 'listen' && (
              <div className="flex flex-col items-center justify-center h-full animate-fade-in py-8">
                <div className="mb-6 text-center">
                  <h3 className="text-xl font-bold mb-2">å°ˆå¿ƒè½æ•™ç·´èªªï¼</h3>
                  <p className="text-gray-500 text-sm">æŒ‰ä¸‹å–‡å­æŒ‰éˆ•æ’­æ”¾ (Listen Carefully)</p>
                </div>
                <button 
                  onClick={speakSentence}
                  className="bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-full shadow-lg transform transition active:scale-95"
                >
                  <Volume2 size={48} />
                </button>
              </div>
            )}

            {/* Mode: SPEAK (å£èªª/æ‰“æ“Šè¨“ç·´) */}
            {mode === 'speak' && (
              <div className="flex flex-col items-center justify-center h-full animate-fade-in py-4">
                <h3 className="text-xl font-bold mb-4">è¼ªåˆ°ä½ æ‰“æ“Šäº†ï¼(Read Aloud)</h3>
                <p className="text-lg font-medium text-center mb-6 bg-gray-50 p-2 rounded text-gray-600">
                  "{currentCard.sentence}"
                </p>
                
                <button 
                  onClick={startListening}
                  disabled={isListening}
                  className={`${isListening ? 'bg-red-500 animate-pulse' : 'bg-green-500 hover:bg-green-600'} text-white p-6 rounded-full shadow-lg mb-4 transition-all`}
                >
                  <Mic size={40} />
                </button>
                
                <div className="h-8 text-center font-mono text-sm text-gray-500">
                  {isListening ? "Listening..." : transcript}
                </div>

                {feedback === 'correct' && (
                   <div className="mt-4 flex items-center text-green-600 font-bold text-xl animate-bounce">
                     <Check size={24} className="mr-1" /> HOMERUN! å”¸å¾—å¤ªæ£’äº†!
                   </div>
                )}
                {feedback === 'incorrect' && (
                   <div className="mt-4 flex items-center text-orange-500 font-bold animate-shake">
                     <X size={24} className="mr-1" /> FOUL BALL! å†è©¦ä¸€æ¬¡!
                   </div>
                )}
              </div>
            )}

            {/* Mode: WRITE (å¯«ä½œ/æˆ°è¡“é»˜å¯«) */}
            {mode === 'write' && (
              <div className="animate-fade-in pt-4">
                <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                  <Edit3 size={20} /> å¡«å¯«é—œéµå­— (Fill in blanks)
                </h3>
                <p className="mb-4 text-lg text-center">
                  {currentCard.sentence.split(' ').map((word, i) => {
                     // ç°¡å–®é®è”½é‚è¼¯ï¼šé®è”½ keywords
                     const cleanWord = word.replace(/[.,]/g, '');
                     const isKeyword = currentCard.keywords.some(k => cleanWord.toLowerCase().includes(k.toLowerCase()));
                     return isKeyword ? <span key={i} className="inline-block w-16 border-b-2 border-black mx-1"></span> : word + ' ';
                  })}
                </p>
                
                <input 
                  type="text" 
                  value={userInput}
                  onChange={(e) => setUserInput(e.target.value)}
                  placeholder="è¼¸å…¥ç¼ºå°‘çš„å–®å­— (ç”¨ç©ºç™½éš”é–‹)"
                  className="w-full border-2 border-gray-300 rounded-lg p-3 text-lg mb-4 focus:border-blue-500 focus:outline-none"
                />
                
                <button 
                  onClick={checkWriting}
                  className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition"
                >
                  æ®æ£’ (Submit)
                </button>

                {feedback === 'correct' && (
                   <div className="mt-4 text-center text-green-600 font-bold text-xl">
                     NICE PLAY! ç­”å°äº†!
                   </div>
                )}
              </div>
            )}

          </div>

          {/* åº•éƒ¨å°èˆªæ¢ */}
          <div className="bg-gray-100 p-2 flex justify-between items-center border-t border-gray-200">
             <div className="flex gap-1">
               <NavBtn icon={<BookOpen size={18}/>} active={mode==='read'} onClick={() => {setMode('read'); setFeedback(null);}} label="è®€" />
               <NavBtn icon={<Volume2 size={18}/>} active={mode==='listen'} onClick={() => {setMode('listen'); setFeedback(null);}} label="è½" />
               <NavBtn icon={<Mic size={18}/>} active={mode==='speak'} onClick={() => {setMode('speak'); setFeedback(null);}} label="èªª" />
               <NavBtn icon={<Edit3 size={18}/>} active={mode==='write'} onClick={() => {setMode('write'); setFeedback(null);}} label="å¯«" />
             </div>
             
             <button 
               onClick={nextCard}
               className="flex items-center gap-1 bg-black text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition"
             >
               NEXT <ChevronRight size={16} />
             </button>
          </div>
        </div>
      </div>

      <style>{`
        .animate-bounce-slow { animation: bounce 2s infinite; }
        .perspective-1000 { perspective: 1000px; }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.5s ease-in-out; }
      `}</style>
    </div>
  );
};

// ç°¡å–®çš„å°èˆªæŒ‰éˆ•çµ„ä»¶
const NavBtn = ({ icon, active, onClick, label }) => (
  <button 
    onClick={onClick}
    className={`flex flex-col items-center justify-center w-12 h-12 rounded-lg transition-all ${active ? 'bg-blue-600 text-white shadow-md scale-105' : 'text-gray-400 hover:bg-gray-200'}`}
  >
    {icon}
    <span className="text-[10px] font-bold mt-0.5">{label}</span>
  </button>
);

export default BaseballApp;
